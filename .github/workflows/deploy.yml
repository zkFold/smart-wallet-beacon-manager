name: Deploy

on:
  push:
    branches:
      - deploy

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-central-1
  AWS_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
  TARGET_INSTANCE: ${{ secrets.AWS_TARGET_INSTANCE_ID }}
  SSM_DOCUMENT_NAME: deploy-smart-wallet-server

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Trigger deployment via SSM
        id: trigger-ssm
        run: |
          command_id=$(aws ssm send-command \
            --document-name "$SSM_DOCUMENT_NAME" \
            --instance-ids "$TARGET_INSTANCE" \
            --query 'Command.CommandId' \
            --output text)

          echo "command_id=$command_id" >> "$GITHUB_OUTPUT"

      - name: Wait for and inspect SSM command
        id: wait-ssm
        env:
          COMMAND_ID: ${{ steps.trigger-ssm.outputs.command_id }}
        run: |
          set -euo pipefail

          # Block until the command finishes (waiter fails on timeout/failed status).
          if ! aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$TARGET_INSTANCE"; then
            echo "SSM waiter reported a failure or timeout" >&2
          fi

          invocation=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$TARGET_INSTANCE")

          status=$(echo "$invocation" | jq -r '.Status')
          stdout=$(echo "$invocation" | jq -r '.StandardOutputContent')
          stderr=$(echo "$invocation" | jq -r '.StandardErrorContent')

          echo "--- Stdout ---"
          printf '%s\n' "$stdout"

          echo "--- Stderr ---"
          printf '%s\n' "$stderr"

          if [ "$status" != "Success" ]; then
            echo "Deployment failed with status: $status" >&2
            exit 1
          fi
